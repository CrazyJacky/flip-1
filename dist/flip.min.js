(function(a){function i(a,b){var c=a&&a.length;for(var d=0;c&&d<a.length;d++)typeof a[d]!="undefined"&&(c=c&&a[d],b.push(a[d]));return c}function j(a){return a.getAttribute("href")||"home"}function k(a){return g[a]||(g[a]=a.replace(d,"").replace(/\//g,".").replace(e,"")),g[a]}function l(a){return function(b){var c=b.target||b.srcElement,d;while(c&&typeof c.href=="undefined")c=c.parentNode;d=a.isRoute(c,b),d.valid&&(b.preventDefault(),a.activate(d.route,d.promises))}}function m(a,b,c,d){var e=!0;for(var f=0;a&&f<a.length;f++)e=e&&(typeof a[f]=="undefined"||a[f]),e&&typeof a[f]!="undefined"&&b.push(a[f]);e&&when.all([].concat(b),c,d)}function n(a,b,c){var d=c.dataset,e,f;if(a===""||a==="/")a="home";if(!d){d={};for(e in routable.attributes)h.test(e)&&(d[RegExp.$1]=routable.attributes[e])}this.data={};for(e in d)this.data[e]=d[e];this.url=a,this.regex=new RegExp("^"+a),this.element=c,this.pageName=k(a),this.flipper=b,this.flipper.on("flip.to."+this.pageName,function(){return!0})}function o(a,c){c=c||{},c.title=c.title||"Untitled App";if(typeof a=="string"||a instanceof String)a=b("#"+a.replace(f,""))[0];this.element=a||document.body,this.id=this.element.id||"flipper_"+(new Date).getTime(),this.routes=[],this.activeRoute=null,this.defaultRoute=null,this.events={activating:"flip.activating",changed:"flip.changed",init:"flip.init"},this.init()}function p(a,b){var d=new o(a,b);return c[d.id]=d,d}var b=function(){var a=/^\.([\w-]+)$/,b=/^#([\w-]+)$/,c=/^[\w-]+$/;return function(d,e){var f;return e=e||document,f=e===document&&b.test(d),f?[e.getElementById(RegExp.$1)]:Array.prototype.slice.call(a.test(d)?e.getElementsByClassName(RegExp.$1):c.test(d)?e.getElementsByTagName(d):e.querySelectorAll(d))}}(),c={},d=/\.\w+$/,e=/^\./,f=/^\#/,g={},h=/^data\-(.*)$/i;o.prototype.activate=function(a,b,c){var d=this,e,f=[];if(typeof a=="string"||a instanceof String)a=this.findRoute(a);a&&a.element&&when.all(b||[],function(){classtweak(".flip-active","-flip-active",d.element),e=i(eve(d.events.activating,d,a,d.activeRoute,c),f),when.all([e].concat(f),function(){classtweak(a.element,"+flip-active"),eve(d.events.changed,d,a,d.activeRoute,c),d.activeRoute=a})})},o.prototype.findRoute=function(a){for(var b=0;b<this.routes.length;b++)if(this.routes[b].regex.test(a))return this.routes[b];return undefined},o.prototype.init=function(){var a=this,c,d,e,f=l(this),g;if(this.element.id)for(c in this.events)this.events[c]+="."+this.element.id;classtweak(this.element,"+flipper"),d=b("*[data-route]",this.element);for(e=0;e<d.length;e++)this.routes.push(new n(d[e].getAttribute("data-route"),this,d[e]));this.element.addEventListener("touchstart",f,!1),this.element.addEventListener("click",f,!1),g=b(".flip-active",this.element).concat(b('[data-route="/"]',this.element),b("section, .section",this.element))[0];if(g){var h=g.getAttribute("data-route");this.defaultRoute=h?new n(h,this,g):null}eve(this.events.init,this,this.element),this.activate(this.defaultRoute),setTimeout(function(){classtweak(a.element,"+flip-ready")},10)},o.prototype.isRoute=function(a,b){var c=!1,d,e,f,g=this.activeRoute,h=[];return a&&a.href&&(d=j(a),f="flip.to."+k(d)+"."+this.id,c=g&&g.path===d,c||(g=this.findRoute(d),e=g?eve(f,this,g,this.activeRoute,b):null,c=i(e,h))),{valid:c,route:g,promises:h}},o.prototype.on=function(a,b){eve.on(a+"."+this.id,b)},p.get=function(a){return c[a]},typeof module!="undefined"&&module.exports?module.exports=p:typeof define!="undefined"?define("flip",[],function(){return p}):a.flip=p})(this)